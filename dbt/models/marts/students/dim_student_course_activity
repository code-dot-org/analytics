-- version: 2.0 (JS)


with 
user_levels as (
/*
    1. User Course Activity
    
    This is the mostly costly part of the model, so we will
    build it as easily as possible and earlier in the process...
    
    This first combination allows us to pull together all the user level activity and course data we need to build the rest of the model. 
    
    We can also roll through our aggregates and other calculations so as to not do them each time in some larger downstream query...
*/
    select 
        -- keys 
        
        user_id as student_id, 
        -- If it's a student model, let's maintain prior conventions
        
        level_id,
        script_id,
        
        -- dates 
        date_trunc('day', created_at)    as activity_date,
        extract('month' from created_at) as activity_month,
        
        -- aggs
        max(attempts)       as total_attempts,
        max(best_result)    as best_result,
        sum(time_spent)     as time_spent_minutes
    from {{ ref('stg_dashboard__user_levels') }}
    {{ dbt_utils.group_by(3) }}
), 

course_structure as (
    select
        course_name,
        course_id,
        level_id,
        level_name,
        level_type,
        unit        as unit_name,
        stage_name  as lesson_name
    from {{ ref('dim_course_structure') }}
    
    where participant_audience = 'student' 
    -- Note: filter out data we don't want or need as early as possible. If we keep it around, it will be continuously processed as it is referenced in other queries.
),

school_years as (
    select * 
    from {{ ref('int_school_years') }}
),

student_activity as (
    select 
        ul.* ,
        sy.school_year

        -- calc for qtr 
        case 
            when ul.activity_month in (7,8,9)       then 'Q1'
            when ul.activity_month in (10,11,12)    then 'Q2'
            when ul.activity_month in (1,2,3)       then 'Q3'
            when ul.activity_month in (4,5,6)       then 'Q4'
        end as activity_quarter, 

        cs.course_name,
        cs.level_name,
        cs.level_type,
        cs.unit_name,
        cs.lesson_name

    from user_levels as ul 
    left join course_structure as cs
        on ul.level_id = cs.level_id
        and ul.script_id = cs.script_id
    join school_years as sy
        on comb.activity_date 
            between sy.start_date 
                and sy.end_date
),

/* 
    2. Sections and Students
    
    We now have all that taken care of, so our join will be simpler later on (and less data in memory)

    Next, we need to map each student to their section(s). This is another big one but only bc our student_activity isn't unique to student_id... so we can pre-process out that work as well.
*/

section_mapping as (
    select * 
    from {{ ref('int_section_mapping') }}

    where student_id in (select user_id from combined)
    -- Note: again, filter out anything we don't need. We need to keep the ship as light as possible.
),

section_size as (
    select 
        section_id,
        count(distinct student_id) as section_size 
    from section_mapping
),

sections as (
    select 
        scm.*,
        -- Note: I don't actually need student_activity data here, so I won't bother to load it 
    
        scz.section_size
    from section_mapping    as scm 
    join section_size       as scz 
        on scm.section_id = scz.section_id 
    join student_activity   as sta 
        on scm.student_id = sta.student_id 
        and scm.school_year = sta.school_year
),

/*
    So now that we have our student_activity and section mapping built, we can smash them together to get our full sections and status data 

    3. Teachers and Schools
        a. Use student_id to connect to sections
        b. Use teacher, school_id for statuses
        c. select * that shit
        d. almost forgot user_geo info 
*/

schools as (
    select * 
    from {{ ref('dim_schools') }}
),

users as (
    select user_id, is_international, country 
    from {{ ref('dim_users') }}
),

school_status as (
    select school_id, school_year, school_status
    from {{ ref('dim_school_status') }}
),

teacher_status as (
    select teacher_id, school_year, status as teacher_status  
    from {{ ref('dim_teacher_status') }}
),

combined as (
    select 
        sec.school_year, 
        
        -- teachers
        sec.teacher_id, 
        tes.teacher_status,

        -- schools
        sec.school_id,
        sch.school_status,
        sch.school_name             as school_name,
        sch.school_district_id      as school_district_id,
        sch.school_district_name    as school_district_name,
        sch.state                   as school_state,
        sch.school_type             as school_type,
        sch.is_stage_el             as school_is_stage_el,
        sch.is_stage_mi             as school_is_stage_mi,
        sch.is_stage_hi             as school_is_stage_hi,
        sch.is_high_needs           as school_is_high_needs,
        sch.is_rural                as school_is_rural,

        usr.student_id,
        usr.is_international,
        usr.country

    from sections   as sec 
    
    join teacher_status as tes 
        on tes.teacher_id   = sec.teacher_id 
        and tes.school_year = sec.school_year
    
    join school_status as sst 
        on  sec.school_id   = sst.school_id 
        and sec.school_year = sst.school_year 
    
    join schools    as sch
        on sch.school_id = sec.school_id 
    join users      as usr 
        on usr.user_id = sec.student_id
),

final as (
    select * 
    from combined
    cross join student_activity
    using student_id, school_year
)

select * from final 
limit 1 