version: 2

models: 
  - name: dim_active_teachers
    description: |
      This model is a comprehensive view of daily teacher activities that roll into the 'active teacher' metric. 

      A teacher is 'active' on a day if they sign-in or perform any one of the set of core teacher actions that we capture via Amplitude.
      (for more details see - placeholder for doc - or the RED team).
      
      The model merges platform sign-in data with event data from Amplitude. For both sign-ins and various event interactions
      captured via Amplitude, it captures both occurrence of these events (multiple events aggregated to a day), as well 
      as geographical and user type information. Amplitude data can be joined to platform data via a Code.org user_id which 
      Amplitude tracks once it learns that a user is a Code.org user. 
      
      In cases where we have data about a user from both Amplitude and Code.org, for example which country the user is from, we merge
      it together giving preference to the Code.org version of that data.

    columns:
      - name: event_date_merged
        description: "The date on which either a sign-in or an Amplitude event was recorded (or both). This field merges dates from sign-ins and Amplitude events to align activities across sources."
        data_type: "date"
        tests:
          - not_null

      - name: user_id_merged
        description: "A unified identifier for the user that merges user IDs from Code.org platform sign-ins and Amplitude events, ensuring consistent tracking across sources. This user_id will be the user's Code.org user_id if it is known or the amplitude_id if not."
        data_type: "varchar"
        tests:
          - not_null


      - name: user_type_merged
        description: merges the Code.org user account type 'teacher' or 'student', or if anyonymous 'amp user'. The account type can be 'student' in cases where Amplitude is tracking activity of a user who has a code.org user id but is a student account.
        data_type: "varchar"

      - name: country_merged
        description: "Country information for the user, merges Code.org geolocation and Amplitude geoloation data. Preference is given to the Code.org data in the case of a conflict between sources."
        data_type: "varchar"

      - name: us_intl_merged
        description: "Values are `us` or `intl`. Indicates whether the user's country (see: country_merged) is in the US or non-us."
        data_type: "varchar"


      - name: user_id
        description: "The Code.org user ID from the sign-in data."
        data_type: "varchar"

      - name: user_id_amp
        description: "The users Code.org user ID as recorded in Amplitude, used in tracking amplitude event data."
        data_type: "varchar"

      - name: amplitude_id
        description: "Amplitude's unique identifier for a user, used in tracking event data."
        data_type: "varchar"

      - name: merged_user_id_source
        description: |
          Where the user_id in user_id_merged came from. Values are: 
            - `cdo` - came from code.org sign-in data
            - `ampcdo` - it's in both amplitude event data and and code.org sign-in data
            - `anon` -  Amplitude_id means the user is anonymous
        data_type: "varchar"

      - name: country
        description: "The country as reported in the Code.org sign-in data."
        data_type: "varchar"

      - name: country_amp_cdo
        description: "The country of the user from Code.org's geolocation data in the case this amplitude user has a code.org user id associated with them."
        data_type: "varchar"

      - name: country_amp
        description: "The country as reported by Amplitude data."
        data_type: "varchar"

      - name: us_intl
        description: "Indicator of whether the user's country (see: `country`) the U.S. or international from code.org sign-in data."
        data_type: "varchar"

      - name: us_intl_amp_cdo
        description: "Indicator of whether the user's country (see: `country_amp_cdo`) is the U.S. or international from code.org geolocation data in the case this amplitude user has a code.org user id associated with them."
        data_type: "varchar"

      - name: us_intl_amp
        description: "Amplitude data of the user's country (see: `country_amp`) is US or international."
        data_type: "varchar"

      - name: user_type
        description: "The user type from the Code.org sign-in data, specifying the role of the user."
        data_type: "varchar"

      - name: user_type_amp_cdo
        description: "The user type as captured from Amplitude when linked with Code.org user IDs."
        data_type: "varchar"

      - name: events_list_amp
        description: |
          This column contains a comma-separated list of Amplitude event names for activities teachers engaged in, that has been cleaned, and shortend for readability and analysis. The original event names from Amplitude are mapped to more concise versions as follows:
          - '[Amplitude event name]' --> '[shortened version]'
          - 'Teacher Viewing Student Work' --> 'View Work'
          - 'Section Progress Viewed' -->  'View Progress'
          - 'Teacher Login' -->  'Login Page'
          - 'Unit Overview Page Visited By Teacher' --> 'View Unit Page'
          - 'Lesson Overview Page Visited' -->  'View Lesson Plan'
          - 'Section Progress Unit Changed' --> 'Change unit'
        data_type: "text"

      - name: events_list_merged
        description: "The `events_list_amp` with 'sign-in` appended to the end if this user for this date also had a Code.org sign-in"
        data_type: "text"

      - name: cdo_sign_in_count
        description: "Count of sign-ins from Code.org data for the user."
        data_type: "integer"

      - name: amp_num_records
        description: "The number of records from Amplitude for the user for this date"
        data_type: "integer"

      - name: cdo_num_records
        description: "The number of sign-in records from Code.org for this date"
        data_type: "integer"

      - name: known_cdo_user
        description: "A boolean flag indicating if the user is recognized as a Code.org user, either through direct sign-ins or Amplitude's data."
        data_type: "boolean"

      - name: has_amp_event
        description: "A boolean flag indicating the presence of an Amplitude event for the user."
        data_type: "boolean"

      - name: has_cdo_sign_in
        description: "A boolean flag indicating the presence of a Code.org sign-in event for the user."
        data_type: "boolean"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - user_id_merged
            - event_date_merged
            - user_type_merged
            - us_intl_merged

  - name: dim_teachers
    description: one row per teacher account ever created, with geographic information and current school association
      
    columns: 
      - name: user_id
        description: unique ID for every teacher account created
        tests: 
          - not_null
          - unique

      - name: studio_person_id
        description: ID used for PD applications where we want to associated multiple teacher IDs with a single application
      
      # - name: user_type
      #   description: always "teacher" - used for verification
      
      # - name: school_info_id
      #   description: ID populated for any school manually entered by the teacher or found through the NCES dropdown- generally we do not use this field downstream
      
      - name: created_at_school_year
        description: the school year in which the teacher account was created
      
      - name: school_id
        description: ID populated if the teacher selected their school from the NCES dropdown menu- this is the school identifier used in downstream models
      
      - name: is_international
        description: 1 if the most recent sign in from the teacher account was from outside the US, 0 otherwise 

  - name: dim_teacher_status
    description: |
      1 row per teacher, per school_year, with "active" defined by having a section of 5+ students completing 1+ levels of the same course. The teacher's status can thus be defined by one of the following in a given school year--
      
      ### active new 
      * has never before been "active" until this school year
      ### active retained 
      * was "active" the previous school year and this school year
      ### active reacquired 
      * was "inactive churn" last school year and now "active" this school year.  
      ### inactive this year 
      * was "active" last school year, but not so far this school year. 
      ### inactive churn 
      * was "inactive" last school year and so far this school year. 
      ### market 
      * has a code.org account, but has never been considered "active" 

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - school_year
            - teacher_id